name: MagicBag CI/CD â†’ Smart Build + SonarQube + Docker + EC2 + ZAP DAST

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_strategy:
        description: 'æ„å»ºç­–ç•¥'
        required: true
        default: 'full'
        type: choice
        options:
          - incremental  # ä»…æ„å»ºä¿®æ”¹çš„æœåŠ¡
          - full         # æ„å»ºæ‰€æœ‰æœåŠ¡

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  AWS_REGION: ap-southeast-1
  MAVEN_OPTS: "-Dmaven.repo.local=/tmp/m2-cache"
  TARGET_URL: http://${{ secrets.EC2_HOST }}:10016

jobs:
  detect-changes:
    name: ğŸ” Detect Changed Microservices
    runs-on: ubuntu-latest
    outputs:
      changed_modules: ${{ steps.set_output.outputs.changed_modules }}
      has_changes: ${{ steps.set_output.outputs.has_changes }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦æ¯”è¾ƒä¸Šä¸€æ¬¡æäº¤

      - name: ğŸ“‚ Identify Modules (Full/Incremental)
        id: set_output
        run: |
          # 1. è·å–å…¨é‡æ¨¡å—åˆ—è¡¨ï¼ˆæ‰€æœ‰åŒ…å« pom.xml çš„å­ç›®å½•ï¼‰
          ALL_MODULES=()
          while IFS= read -r file; do
            DIR=$(dirname "$file")
            if [ "$DIR" != "." ] && [[ "$DIR" != *"/target/"* ]]; then
              ALL_MODULES+=("$DIR")
            fi
          done <<< "$(find . -name 'pom.xml' -not -path './pom.xml')"
          
          UNIQUE_ALL_MODULES=($(printf "%s\n" "${ALL_MODULES[@]}" | sort -u))
          ALL_MODULE_LIST=$(IFS=','; echo "${UNIQUE_ALL_MODULES[*]}")
          echo "å…¨é‡æ¨¡å—åˆ—è¡¨: $ALL_MODULE_LIST"
          
          # 2. æ£€æŸ¥æ„å»ºç­–ç•¥ï¼Œå…¨é‡æ„å»ºç›´æ¥è¿”å›æ‰€æœ‰æ¨¡å—
          BUILD_STRATEGY="${{ github.event.inputs.build_strategy || 'incremental' }}"
          if [ "$BUILD_STRATEGY" = "full" ]; then
            echo "ä½¿ç”¨å…¨é‡æ„å»ºç­–ç•¥"
            echo "changed_modules=$ALL_MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 3. å¢é‡æ„å»ºé€»è¾‘ä¼˜åŒ–
          CHANGED_MODULES=()
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨: $CHANGED_FILES"
          
          # æ£€æµ‹æ˜¯å¦æœ‰ workflow é…ç½®å˜æ›´ï¼ˆéœ€è¦è§¦å‘å…¨é‡æ„å»ºï¼‰
          if echo "$CHANGED_FILES" | grep -q ".github/workflows/"; then
            echo "æ£€æµ‹åˆ° workflow é…ç½®å˜æ›´ï¼Œè§¦å‘å…¨é‡æ„å»º"
            echo "changed_modules=$ALL_MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æµ‹ pom.xml å˜æ›´
          while IFS= read -r file; do
            if [[ "$file" == *"pom.xml" ]]; then
              DIR=$(dirname "$file")
              if [ "$DIR" != "." ] && [[ "$DIR" != *"/target/"* ]]; then
                CHANGED_MODULES+=("$DIR")
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          # å»é‡å¤„ç†
          UNIQUE_MODULES=($(printf "%s\n" "${CHANGED_MODULES[@]}" | sort -u))
          
          if [ ${#UNIQUE_MODULES[@]} -eq 0 ]; then
            echo "No module changes detected."
            echo "changed_modules=none" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            MODULE_LIST=$(IFS=','; echo "${UNIQUE_MODULES[*]}")
            echo "Changed modules: $MODULE_LIST"
            echo "changed_modules=$MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
  build-and-scan:
    name: ğŸ§ª Build Changed & SonarQube Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â±ï¸ Cache Maven packages
        uses: actions/cache@v3
        with:
          path: /tmp/m2-cache
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: âš™ï¸ Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”‘ Generate CodeArtifact settings.xml
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain se \
            --domain-owner 935194211492 \
            --region ${{ env.AWS_REGION }} \
            --query authorizationToken --output text)
          REPO_URL="https://se-935194211492.d.codeartifact.${{ env.AWS_REGION }}.amazonaws.com/maven/magic-bag/"
          mkdir -p /tmp/m2-cache
          cat > /tmp/m2-cache/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>${TOKEN}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </repository>
                </repositories>
                <pluginRepositories>
                  <pluginRepository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </pluginRepository>
                </pluginRepositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>
          EOF

      - name: ğŸ§ª Build Only Changed Microservices
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            if [ ! -f "$MODULE/pom.xml" ]; then
              echo "âš ï¸ Skip $MODULE: no pom.xml"
              continue
            fi
            echo "ğŸ“¦ Building $MODULE..."
            mvn -B -pl "$MODULE" clean compile test \
              -s /tmp/m2-cache/settings.xml \
              -Dmaven.repo.local=/tmp/m2-cache
          done

      - name: ğŸ“Š SonarQube Scan (Changed Modules Only)
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            if [ -f "$MODULE/pom.xml" ]; then
              echo "ğŸ” Scanning module: $MODULE"
          
              mvn -B -pl "$MODULE" -am sonar:sonar \
                -s /tmp/m2-cache/settings.xml \
                -Dmaven.repo.local=/tmp/m2-cache \
                -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
                -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
                -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
                -Dsonar.projectKey="magic-bag-parent"
            fi
          done

      - name: ğŸ“¤ Upload Built JARs (Only Changed)
        uses: actions/upload-artifact@v4
        with:
          name: built-jars
          path: |
            ${{ needs.detect-changes.outputs.changed_modules }}/target/*.jar

  build-and-deploy:
    name: ğŸ³ Build Docker & Deploy to EC2
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-scan]
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Built JARs
        uses: actions/download-artifact@v4
        with:
          name: built-jars
          path: .

      - name: ğŸ” Restore JARs to target Directories
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            mkdir -p "$MODULE/target"
            JAR=$(find . -name "${MODULE}-*.jar" | head -n1)
            if [ -n "$JAR" ]; then
              cp "$JAR" "$MODULE/target/app.jar"
              echo "âœ… Copied $JAR to $MODULE/target/app.jar"
            else
              echo "âŒ JAR not found for $MODULE"
              exit 1
            fi
          done

      - name: ğŸ³ Build Docker Images (Only Changed)
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            if [ -f "$MODULE/Dockerfile" ]; then
              BASE_NAME=$(echo "$MODULE" | cut -d'-' -f3-)
              case "$BASE_NAME" in
                "gateway") PORT=10016 ;;
                "auth") PORT=10017 ;;
                "user") PORT=10018 ;;
                "product") PORT=10019 ;;
                "order") PORT=10020 ;;
                "payment") PORT=10021 ;;
                "cart") PORT=10022 ;;
                "merchant") PORT=10023 ;;
                "admin") PORT=10024 ;;
                *) PORT=8080 ;;
              esac
              echo "ğŸ³ Building $MODULE on port $PORT..."
              docker build -f "$MODULE/Dockerfile" \
                --build-arg SERVICE_NAME="$MODULE" \
                --build-arg APP_PORT="$PORT" \
                --build-arg TZ=Asia/Singapore \
                -t ${{ secrets.DOCKERHUB_USERNAME }}/"$MODULE":latest .
            fi
          done

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸš€ Push Changed Images to Docker Hub
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/"$MODULE":latest
          done

      - name: ğŸŒ Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            docker compose down
            docker compose pull
            docker compose --env-file .env up -d
            docker image prune -f

  dast-scan:
    name: ğŸ›¡ï¸ ZAP DAST Security Scan
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    steps:
      - name: â³ Wait for Service to Be Ready
        run: |
          echo "â³ Waiting 30s for services to start..."
          sleep 30
          echo "ğŸ“¡ Testing connectivity to ${{ env.TARGET_URL }}"
          curl -f --retry 5 --retry-delay 5 --max-time 10 ${{ env.TARGET_URL }}/actuator/health || exit 1

      - name: ğŸ•µï¸ Run ZAP Baseline Scan
        run: |
          mkdir -p zap-report
          docker run -v $PWD/zap-report:/zap/wrk:rw \
            --rm \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-report.html

      - name: ğŸ“¤ Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-report
          path: zap-report/zap-report.html

      - name: âŒ Fail on High/Critical Alerts (Optional)
        run: |
          if grep -q "High.*>" zap-report/zap-report.html || grep -q "Critical.*>" zap-report/zap-report.html; then
            echo "ğŸ’¥ ZAP found High/Critical vulnerabilities!"
            exit 1
          else
            echo "âœ… No High/Critical issues found."
          fi