name: üöÄ Magic Bag CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_strategy:
        description: 'Build strategy (full/incremental)'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: üîç Detect Changed Microservices
    runs-on: ubuntu-latest
    outputs:
      changed_modules: ${{ steps.set_output.outputs.changed_modules }}
      has_changes: ${{ steps.set_output.outputs.has_changes }}
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìÇ Identify Modules (Full/Incremental)
        id: set_output
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "üí° Detected 'main' branch ‚Üí forcing full build."
            ALL_MODULES=()
            while IFS= read -r file; do
              DIR=$(dirname "$file")
              if [ "$DIR" != "." ] && [[ "$DIR" != *"/target/"* ]]; then
                ALL_MODULES+=("$DIR")
              fi
            done <<< "$(find . -name 'pom.xml' -not -path './pom.xml')"
            UNIQUE_ALL_MODULES=($(printf "%s\n" "${ALL_MODULES[@]}" | sort -u))
            ALL_MODULE_LIST=$(IFS=','; echo "${UNIQUE_ALL_MODULES[*]}")
            echo "changed_modules=$ALL_MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          ALL_MODULES=()
          while IFS= read -r file; do
            DIR=$(dirname "$file")
            if [ "$DIR" != "." ] && [[ "$DIR" != *"/target/"* ]]; then
              ALL_MODULES+=("$DIR")
            fi
          done <<< "$(find . -name 'pom.xml' -not -path './pom.xml')"
          UNIQUE_ALL_MODULES=($(printf "%s\n" "${ALL_MODULES[@]}" | sort -u))
          ALL_MODULE_LIST=$(IFS=','; echo "${UNIQUE_ALL_MODULES[*]}")

          BUILD_STRATEGY="${{ github.event.inputs.build_strategy || 'incremental' }}"
          if [ "$BUILD_STRATEGY" = "full" ]; then
            echo "changed_modules=$ALL_MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          if echo "$CHANGED_FILES" | grep -q ".github/workflows/"; then
            echo "changed_modules=$ALL_MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED_MODULES=()
          while IFS= read -r file; do
            if [[ "$file" == *"pom.xml" ]]; then
              DIR=$(dirname "$file")
              if [ "$DIR" != "." ] && [[ "$DIR" != *"/target/"* ]]; then
                CHANGED_MODULES+=("$DIR")
              fi
            fi
          done <<< "$CHANGED_FILES"

          UNIQUE_MODULES=($(printf "%s\n" "${CHANGED_MODULES[@]}" | sort -u))
          if [ ${#UNIQUE_MODULES[@]} -eq 0 ]; then
            echo "changed_modules=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            MODULE_LIST=$(IFS=','; echo "${UNIQUE_MODULES[*]}")
            echo "changed_modules=$MODULE_LIST" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  build-and-scan:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: ‚öôÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: üîë Generate CodeArtifact settings.xml
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain se \
            --domain-owner 935194211492 \
            --region ap-southeast-1 \
            --query authorizationToken --output text)
          REPO_URL="https://se-935194211492.d.codeartifact.ap-southeast-1.amazonaws.com/maven/magic-bag/"
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>${TOKEN}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </repository>
                </repositories>
                <pluginRepositories>
                  <pluginRepository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </pluginRepository>
                </pluginRepositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>
          EOF

      - name: üß™ Build Only Changed Microservices (for tests)
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            if [ ! -f "$MODULE/pom.xml" ]; then
              echo "‚ö†Ô∏è Skip $MODULE: no pom.xml"
              continue
            fi
            echo "üì¶ Building $MODULE..."
            mvn -B -pl "$MODULE" clean compile test -s ~/.m2/settings.xml
          done

      - name: üì§ Upload Unit Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-reports-${{ github.run_id }}
          path: |
            **/target/surefire-reports/TEST-*.xml
            **/target/surefire-reports/*.txt
          retention-days: 7

      - name: üîê Install Snyk CLI
        run: npm install -g snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: üîç Run Snyk SCA Scan
        run: |
          snyk auth ${{ secrets.SNYK_TOKEN }}
          snyk test --file=pom.xml --json-file-output=snyk-report.json || echo "Snyk scan completed."

      - name: üìä Generate Snyk HTML Report
        run: |
          npm install -g snyk-to-html
          snyk-to-html -i snyk-report.json -o snyk-report.html || echo "HTML report skipped."

      - name: üì§ Upload Snyk SCA Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-sca-report-${{ github.run_id }}
          path: |
            snyk-report.json
            snyk-report.html
          retention-days: 7

      - name: üìä SonarQube Scan
        continue-on-error: true
        run: |
          mvn -B clean verify sonar:sonar \
            -s ~/.m2/settings.xml \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.projectKey=magic-bag-parent \
            -Dsonar.branch.name=${{ github.ref_name }}
            || echo "‚ö†Ô∏è Sonar scan completed but failed to validate default branch. Analysis still uploaded."

  build-and-deploy:
    needs: [detect-changes, build-and-scan]
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' && github.ref_name == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: ‚öôÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: üîë Generate CodeArtifact settings.xml
        run: |
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain se \
            --domain-owner 935194211492 \
            --region ap-southeast-1 \
            --query authorizationToken --output text)
          REPO_URL="https://se-935194211492.d.codeartifact.ap-southeast-1.amazonaws.com/maven/magic-bag/"
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>${TOKEN}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </repository>
                </repositories>
                <pluginRepositories>
                  <pluginRepository>
                    <id>codeartifact</id>
                    <url>${REPO_URL}</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </pluginRepository>
                </pluginRepositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>
          EOF

      - name: üìÅ Prepare .m2/settings.xml for Docker
        run: |
          mkdir -p .m2
          cp ~/.m2/settings.xml .m2/settings.xml

      - name: üß™ Rebuild Changed Modules (for packaging)
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          for MODULE in "${MODULES[@]}"; do
            if [ ! -f "$MODULE/pom.xml" ]; then
              echo "‚ö†Ô∏è Skip $MODULE: no pom.xml"
              continue
            fi
            echo "üì¶ Packaging $MODULE..."
            mvn -B -pl "$MODULE" package -DskipTests -s ~/.m2/settings.xml
          done

      - name: üê≥ Build Docker Images (Only Changed + Has Dockerfile)
        id: build_images
        run: |
          IFS=',' read -ra MODULES <<< "${{ needs.detect-changes.outputs.changed_modules }}"
          BUILT_IMAGES=()
          for MODULE in "${MODULES[@]}"; do
            if [ ! -f "$MODULE/Dockerfile" ]; then
              echo "‚ö†Ô∏è Skip $MODULE: no Dockerfile"
              continue
            fi
            CLEAN_MODULE="${MODULE#./}"
            IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${CLEAN_MODULE}:latest"
            echo "üê≥ Building ${CLEAN_MODULE} ‚Üí ${IMAGE_NAME} ..."
            case "${CLEAN_MODULE}" in
              "magic-bag-gateway") PORT=10016 ;;
              "magic-bag-auth") PORT=10017 ;;
              "magic-bag-user") PORT=10018 ;;
              "magic-bag-product") PORT=10019 ;;
              "magic-bag-order") PORT=10020 ;;
              "magic-bag-payment") PORT=10021 ;;
              "magic-bag-cart") PORT=10022 ;;
              "magic-bag-merchant") PORT=10023 ;;
              "magic-bag-admin") PORT=10024 ;;
              *) PORT=8080 ;;
            esac
            docker build -f "$MODULE/Dockerfile" \
              --build-arg SERVICE_NAME="${CLEAN_MODULE}" \
              --build-arg APP_PORT="$PORT" \
              --build-arg TZ=Asia/Singapore \
              -t "$IMAGE_NAME" .
            BUILT_IMAGES+=("${CLEAN_MODULE}")
          done
          if [ ${#BUILT_IMAGES[@]} -eq 0 ]; then
            echo "built_modules=" >> $GITHUB_OUTPUT
          else
            BUILT_LIST=$(IFS=','; echo "${BUILT_IMAGES[*]}")
            echo "built_modules=$BUILT_LIST" >> $GITHUB_OUTPUT
          fi

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üöÄ Push Built Docker Images Only
        run: |
          BUILT_MODULES="${{ steps.build_images.outputs.built_modules }}"
          if [ -z "$BUILT_MODULES" ]; then
            echo "üì≠ No Docker images built. Skipping push."
            exit 0
          fi
          IFS=',' read -ra MODULES <<< "$BUILT_MODULES"
          for MODULE in "${MODULES[@]}"; do
            IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${MODULE}:latest"
            echo "üì§ Pushing $IMAGE_NAME ..."
            docker push "$IMAGE_NAME"
          done

      - name: üåê Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            docker compose down
            docker compose pull
            docker compose --env-file .env up -d
            docker image prune -f

  dast-scan:
    needs: build-and-deploy
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚è≥ Wait for Service to Be Ready
        run: |
          echo "‚è≥ Waiting 300s for services to start..."
          sleep 600
          curl -f --retry 5 --retry-delay 5 --max-time 10 http://${{ secrets.EC2_HOST }}:10016/actuator/health || exit 1

      - name: üïµÔ∏è Run ZAP Baseline Scan
        run: |
          mkdir -p zap-report
          docker run -v $PWD/zap-report:/zap/wrk:rw \
            --rm \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t http://${{ secrets.EC2_HOST }}:10016 \
            -r zap-report.html

      - name: üì§ Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-report
          path: zap-report/zap-report.html

      - name: ‚ùå Fail on High/Critical Alerts
        run: |
          if grep -q "High.*>" zap-report/zap-report.html || grep -q "Critical.*>" zap-report/zap-report.html; then
            echo "üí• ZAP found High/Critical vulnerabilities!"
            exit 1
          else
            echo "‚úÖ No High/Critical issues found."
          fi

  performance-test:
    needs: build-and-deploy
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚è≥ Wait for Service to Be Ready
        run: |
          echo "‚è≥ Waiting 60s for services to stabilize..."
          sleep 600
          curl -f --retry 10 --retry-delay 5 --max-time 10 http://${{ secrets.EC2_HOST }}:10016/actuator/health || exit 1

      - name: üß™ Run JMeter Test
        run: |
          mkdir -p jmeter-report
          docker run --rm \
            -v "${PWD}/jmeter:/jmeter" \
            -v "${PWD}/jmeter-report:/report" \
            justb4/jmeter:5.6.2 \
            -n -t /jmeter/magic-bag.jmx \
            -Jhost=${{ secrets.EC2_HOST }} \
            -Jport=10016 \
            -l /report/magic-bag-results.jtl \
            -e -o /report/dashboard

      - name: üì§ Upload JMeter Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report-${{ github.run_id }}
          path: jmeter-report/dashboard/
          retention-days: 7